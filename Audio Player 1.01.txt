--[[
	INTEGRATED AUDIO SUITE v4.0 (The Cassel Tribute)
	"Simplicity is the ultimate sophistication."
	-- Google Gemini Pro assisted 
	Architected for robustness, memory safety, and clean signal flow.
]]

local TweenService = game:GetService("TweenService")
local MarketplaceService = game:GetService("MarketplaceService")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")

-- // UTILITIES //
-- A tiny "Fusion-like" helper for declarative instance creation.
local function Create(className: string, props: {[string]: any}, children: {[any]: Instance}?)
	local inst = Instance.new(className)
	for k, v in pairs(props) do
		if k == "Parent" then continue end
		-- Handle events or properties
		if type(k) == "string" and k:sub(1,2) == "On" and type(v) == "function" then
			local eventName = k:sub(3)
			if inst[eventName] then inst[eventName]:Connect(v) end
		else
			inst[k] = v
		end
	end
	if children then
		for _, child in pairs(children) do child.Parent = inst end
	end
	if props.Parent then inst.Parent = props.Parent end -- Parent last for performance
	return inst
end

-- // THEME CONSTANTS //
local THEME = {
	Bg = Color3.fromRGB(20, 20, 24),
	Panel = Color3.fromRGB(32, 32, 38),
	Accent = Color3.fromRGB(255, 140, 0), -- "Roblox Studio Orange"
	Text = Color3.fromRGB(245, 245, 245),
	SubText = Color3.fromRGB(160, 160, 160),
	Green = Color3.fromRGB(40, 200, 120),
	Red = Color3.fromRGB(220, 60, 60),
	VizBar = Color3.fromRGB(0, 255, 180),
	Hover = Color3.fromRGB(45, 45, 50)
}

-- // AUDIO GRAPH ENGINE (Object Oriented) //
local AudioGraph = {}
AudioGraph.__index = AudioGraph

function AudioGraph.new()
	local self = setmetatable({}, AudioGraph)
	self._root = Instance.new("Folder")
	self._root.Name = "OBM_AudioEngine_v4"
	self._root.Parent = SoundService

	self.Nodes = {
		Player = Create("AudioPlayer", {Parent=self._root, Name="MainPlayer", Looping=true}),
		Fader = Create("AudioFader", {Parent=self._root, Name="MainFader", Volume=0.5}),
		Output = Create("AudioDeviceOutput", {Parent=self._root, Name="MainOutput"}),
	}

	self.Effects = {} -- { {Instance=obj, Type="AudioReverb"}, ... }
	self:RebuildWires()
	return self
end

function AudioGraph:AddEffect(className: string)
	local fx = Instance.new(className, self._root)
	table.insert(self.Effects, {Instance = fx, Type = className})
	self:RebuildWires()
end

function AudioGraph:RemoveEffect(index: number)
	local item = table.remove(self.Effects, index)
	if item then item.Instance:Destroy() end
	self:RebuildWires()
end

function AudioGraph:RebuildWires()
	-- 1. Clean old wires
	for _, c in ipairs(self._root:GetChildren()) do
		if c:IsA("Wire") then c:Destroy() end
	end

	-- 2. Build Signal Chain: Player -> FX... -> Fader -> Output
	local currentSrc = self.Nodes.Player

	for _, fx in ipairs(self.Effects) do
		Create("Wire", {Parent=self._root, SourceInstance=currentSrc, TargetInstance=fx.Instance})
		currentSrc = fx.Instance
	end

	Create("Wire", {Parent=self._root, SourceInstance=currentSrc, TargetInstance=self.Nodes.Fader})
	Create("Wire", {Parent=self._root, SourceInstance=self.Nodes.Fader, TargetInstance=self.Nodes.Output})
end

function AudioGraph:Play(id: string)
	self.Nodes.Player:Stop()
	self.Nodes.Player.AssetId = "rbxassetid://" .. id
	self.Nodes.Player:Play()
end

function AudioGraph:Destroy()
	self._root:Destroy()
	self.Nodes = nil
	self.Effects = nil
end

-- // VISUALIZER ENGINE //
local VizEngine = {}
VizEngine.__index = VizEngine

function VizEngine.new()
	local self = setmetatable({}, VizEngine)
	self._input = nil
	self._analyzer = nil
	self._wire = nil
	self._connection = nil
	return self
end

function VizEngine:Start(bars: {Frame})
	self:Stop()

	self._input = Create("AudioDeviceInput", {Parent=SoundService})
	pcall(function() self._input.Player = Players.LocalPlayer end)

	self._analyzer = Create("AudioAnalyzer", {Parent=SoundService})
	self._wire = Create("Wire", {Parent=SoundService, SourceInstance=self._input, TargetInstance=self._analyzer})

	self._connection = RunService.RenderStepped:Connect(function()
		local spectrum = self._analyzer:GetSpectrum()
		if not spectrum then return end

		for i, bar in ipairs(bars) do
			local val = math.clamp((spectrum[i] or 0) * 5, 0.05, 1)
			bar.Size = UDim2.new(0.04, 0, val, 0)
			-- Subtle color shift based on intensity
			bar.BackgroundColor3 = THEME.VizBar:Lerp(THEME.Accent, val)
		end
	end)
end

function VizEngine:Stop()
	if self._connection then self._connection:Disconnect() self._connection = nil end
	if self._input then self._input:Destroy() self._input = nil end
	if self._analyzer then self._analyzer:Destroy() self._analyzer = nil end
	if self._wire then self._wire:Destroy() self._wire = nil end
end


-- // MAIN PLUGIN MODULE //
return function(plugin: Plugin, button: TextButton)

	-- 1. Widget Resolution
	local HostWidget = button:FindFirstAncestorWhichIsA("DockWidgetPluginGui")
	if not HostWidget then warn("AudioSuite: Critical - No Host Widget") return end

	-- Cleanup Old Sessions
	if HostWidget:FindFirstChild("OBM_Overlay") then HostWidget.OBM_Overlay:Destroy() end

	-- 2. State Management
	local SavedAudio = plugin:GetSetting("Cassel_Saves") or {'1848354536'}
	local CurrentIdx = 1
	local Graph = AudioGraph.new()
	local Viz = VizEngine.new()

	-- 3. UI Construction (Declarative)
	local Overlay = Create("Frame", {
		Name = "OBM_Overlay", Parent = HostWidget,
		Size = UDim2.fromScale(1,1), BackgroundColor3 = THEME.Bg, ZIndex = 10
	})

	local TopBar = Create("Frame", {
		Parent = Overlay, Size = UDim2.new(1,0,0,40), BackgroundColor3 = THEME.Panel, BorderSizePixel = 0, ZIndex = 20
	})

	local Content = Create("Frame", {
		Parent = Overlay, Size = UDim2.new(1,0,1,-40), Position = UDim2.new(0,0,0,40),
		BackgroundTransparency = 1, ZIndex = 20
	})

	-- Pages
	local PageMusic = Create("Frame", {Parent=Content, Size=UDim2.fromScale(1,1), BackgroundTransparency=1, Visible=true, ZIndex=30})
	local PageMic = Create("Frame", {Parent=Content, Size=UDim2.fromScale(1,1), BackgroundTransparency=1, Visible=false, ZIndex=30})

	-- 4. Components
	local function CreateTab(text, x)
		local btn = Create("TextButton", {
			Parent = TopBar, Text = text, Size = UDim2.new(0.45,0,1,0), Position = UDim2.new(x,0,0,0),
			BackgroundColor3 = THEME.Panel, TextColor3 = THEME.SubText, Font = Enum.Font.GothamBold, TextSize = 13, ZIndex=25
		})
		-- Hover Effect
		btn.MouseEnter:Connect(function() TweenService:Create(btn, TweenInfo.new(0.2), {TextColor3 = THEME.Text}):Play() end)
		btn.MouseLeave:Connect(function() 
			if btn:GetAttribute("Active") then return end
			TweenService:Create(btn, TweenInfo.new(0.2), {TextColor3 = THEME.SubText}):Play() 
		end)
		return btn
	end

	local TabMusic = CreateTab("MUSIC", 0); TabMusic:SetAttribute("Active", true); TabMusic.TextColor3 = THEME.Accent
	local TabMic = CreateTab("MIC TEST", 0.45)

	local BtnClose = Create("TextButton", {
		Parent = TopBar, Text = "✖", Size = UDim2.new(0.1,0,1,0), Position = UDim2.new(0.9,0,0,0),
		BackgroundColor3 = THEME.Red, TextColor3 = Color3.new(1,1,1), Font=Enum.Font.GothamBold, ZIndex=25
	})

	-- 5. Music Page UI
	local InfoLabel = Create("TextLabel", {
		Parent = PageMusic, Text = "Loading...", Size = UDim2.new(1,-20,0,30), Position = UDim2.new(0,10,0,10),
		BackgroundTransparency = 1, TextColor3 = THEME.Accent, Font = Enum.Font.Code, TextSize = 14, TextXAlignment = "Left", ZIndex=31
	})

	local CtrlFrame = Create("Frame", {
		Parent = PageMusic, Size = UDim2.new(1,-20,0,40), Position = UDim2.new(0,10,0,50), BackgroundTransparency = 1, ZIndex=31
	})

	local function CreateCtrl(txt, x, w, color)
		local b = Create("TextButton", {
			Parent = CtrlFrame, Text = txt, Size = UDim2.new(w,-4,1,0), Position = UDim2.new(x,2,0,0),
			BackgroundColor3 = color or THEME.Panel, TextColor3 = THEME.Text, Font = Enum.Font.GothamBold, ZIndex=32
		}, {Create("UICorner", {CornerRadius=UDim.new(0,4)})})
		return b
	end

	local BtnPrev = CreateCtrl("<", 0, 0.15)
	local BtnPlay = CreateCtrl("||", 0.15, 0.2)
	local BtnNext = CreateCtrl(">", 0.35, 0.15)
	local BtnFX   = CreateCtrl("FX +", 0.5, 0.25, Color3.fromRGB(60,60,70))
	local BtnID   = CreateCtrl("ID", 0.75, 0.25)

	local InputID = Create("TextBox", {
		Parent = PageMusic, Size = UDim2.new(0.9,0,0,30), Position = UDim2.new(0.05,0,0,100),
		BackgroundColor3 = Color3.new(0,0,0), TextColor3 = Color3.new(1,1,1), PlaceholderText = "Enter ID...", Visible = false, ZIndex=40
	})

	-- 6. FX Logic & Menus
	local FX_CLASSES = {
		"AudioReverb", "AudioEcho", "AudioChorus", "AudioEqualizer", "AudioPitchShifter", 
		"AudioDistortion", "AudioTremolo", "AudioFlanger", "AudioCompressor"
	}

	local FxScroll = Create("ScrollingFrame", {
		Parent = PageMusic, Size = UDim2.new(0.6,0,0.5,0), Position = UDim2.new(0.35,0,0,100),
		BackgroundColor3 = THEME.Bg, BorderColor3 = THEME.Accent, Visible = false, ZIndex=50, CanvasSize = UDim2.new(0,0,0,#FX_CLASSES*27)
	}, {Create("UIListLayout", {Padding=UDim.new(0,2)})})

	for _, cls in ipairs(FX_CLASSES) do
		local b = Create("TextButton", {
			Parent = FxScroll, Text = cls:gsub("Audio",""), Size = UDim2.new(1,0,0,25),
			BackgroundColor3 = THEME.Panel, TextColor3 = THEME.Text, ZIndex=51
		})

		b.MouseButton1Click:Connect(function()
			-- Intelligent Toggle
			local found = nil
			for i, fx in ipairs(Graph.Effects) do if fx.Type == cls then found = i break end end

			if found then
				Graph:RemoveEffect(found)
				b.BackgroundColor3 = THEME.Panel
			else
				Graph:AddEffect(cls)
				b.BackgroundColor3 = THEME.Green
			end
		end)
	end

	-- 7. Controllers
	local function LoadTrack(idx)
		if idx > #SavedAudio then idx = 1 end
		if idx < 1 then idx = #SavedAudio end
		CurrentIdx = idx
		local id = SavedAudio[CurrentIdx]

		Graph:Play(id)
		InfoLabel.Text = "Loading..."
		BtnPlay.Text = "||"

		task.spawn(function()
			local s, i = pcall(function() return MarketplaceService:GetProductInfo(tonumber(id)) end)
			InfoLabel.Text = (s and i) and ("♫ " .. i.Name) or ("ID: " .. id)
		end)
	end

	-- 8. Visualizer Setup
	local VizFrame = Create("Frame", {
		Parent = PageMic, Size = UDim2.new(0.9,0,0.6,0), Position = UDim2.new(0.05,0,0.2,0),
		BackgroundColor3 = Color3.new(0,0,0), ZIndex=31
	}, {Create("UIListLayout", {FillDirection="Horizontal", HorizontalAlignment="Center"})})

	local Bars = {}
	for i=1, 20 do
		table.insert(Bars, Create("Frame", {Parent=VizFrame, Size=UDim2.new(0.04,0,0.05,0), BackgroundColor3=THEME.VizBar, ZIndex=32}))
	end

	-- 9. Navigation Logic
	local function SetTab(mode)
		TabMusic.TextColor3 = (mode=="Music") and THEME.Accent or THEME.SubText
		TabMic.TextColor3 = (mode=="Mic") and THEME.Accent or THEME.SubText
		PageMusic.Visible = (mode=="Music")
		PageMic.Visible = (mode=="Mic")

		if mode == "Mic" then Viz:Start(Bars) else Viz:Stop() end
	end

	-- 10. Connections
	TabMusic.MouseButton1Click:Connect(function() SetTab("Music") end)
	TabMic.MouseButton1Click:Connect(function() SetTab("Mic") end)

	BtnPrev.MouseButton1Click:Connect(function() LoadTrack(CurrentIdx-1) end)
	BtnNext.MouseButton1Click:Connect(function() LoadTrack(CurrentIdx+1) end)
	BtnPlay.MouseButton1Click:Connect(function() 
		if Graph.Nodes.Player.IsPlaying then 
			Graph.Nodes.Player:Stop() BtnPlay.Text="▶" 
		else 
			Graph.Nodes.Player:Play() BtnPlay.Text="||" 
		end 
	end)

	BtnFX.MouseButton1Click:Connect(function() FxScroll.Visible = not FxScroll.Visible; InputID.Visible = false end)
	BtnID.MouseButton1Click:Connect(function() InputID.Visible = not InputID.Visible; FxScroll.Visible = false end)

	InputID.FocusLost:Connect(function(enter)
		if enter and tonumber(InputID.Text) then
			table.insert(SavedAudio, InputID.Text)
			plugin:SetSetting("Cassel_Saves", SavedAudio)
			LoadTrack(#SavedAudio)
		end
		InputID.Visible = false
	end)

	-- Cleanup Routine
	local function Close()
		SetTab("None") -- Stops Viz
		Graph:Destroy() -- Kills Audio Engine
		Overlay:Destroy() -- Kills UI
		-- Restore Siblings
		for _, child in ipairs(HostWidget:GetChildren()) do
			if child:IsA("GuiObject") then child.Visible = true end
		end
	end
	BtnClose.MouseButton1Click:Connect(Close)

	-- Init
	LoadTrack(CurrentIdx)
end
